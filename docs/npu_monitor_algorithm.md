## NPU 硬件指标动态基线建模与异常判定算法

### 1. 监控对象

以 NPU 硬件关键指标为例（可扩展）：

- **功率**：$P_t$（W）
- **温度**：$T_t$（℃）
- **AI Core 利用率**：$U^{\text{core}}_t$（%）
- **内存利用率**：$U^{\text{mem}}_t$（%）
- **内存带宽利用率**：$U^{\text{bw}}_t$（%）

其中下标 $t$ 表示第 $t$ 次采样。

---

### 2. 动态基线建模（滑动窗口）

对任一指标序列 $x_t$（如温度、功率），维护最近 $W$ 个样本的滑动窗口：

$$
\mathcal{X}_t = \{x_{t-W+1}, \ldots, x_t\},\quad n_t = |\mathcal{X}_t| = \min(W, t)
$$

**滑动均值：**

$$
\mu_t = \frac{1}{n_t}\sum_{i=t-n_t+1}^{t} x_i
$$

**滑动标准差：**

$$
\sigma_t = \sqrt{\frac{1}{n_t}\sum_{i=t-n_t+1}^{t}(x_i - \mu_t)^2}
$$

当 $n_t < N_{\text{min}}$ 时（如 20），认为基线尚不稳定，仅做数据积累，不做动态异常判定。

---

### 3. 静态阈值越界检测（R1 类）

为每个指标配置静态上下限 $[L, U]$，并要求连续 $K$ 次越界才告警。

判定条件：

- 单次是否越界：

$$
\text{out\_of\_range}_t = (x_t < L) \lor (x_t > U)
$$

- 维护连续越界计数 \\(c_t\\)：

$$
c_t =
\begin{cases}
c_{t-1} + 1, & \text{若 } \text{out\_of\_range}_t = \text{true} \\
0,           & \text{否则}
\end{cases}
$$

- **异常条件：**

$$
\text{若 } c_t \ge K \Rightarrow \text{静态阈值异常（R1）}
$$

---

### 4. 动态基线 3σ 异常检测（滑动窗口对比）

当窗口样本数足够且 $\sigma_t > 0$ 时，对当前值 $x_t$ 进行标准化偏差检测：

$$
z_t = \frac{|x_t - \mu_t|}{\sigma_t}
$$

**异常条件：**

$$
\text{若 } z_t > k_\sigma \Rightarrow \text{动态基线异常}
$$

其中 $k_\sigma$ 建议取 $2 \sim 3$（对应约 95\%～99.7\% 置信区间）。

---

### 5. CUSUM 动态趋势偏移检测（R2 类）

针对“缓变”指标（如温度、功率），在静态阈值和动态 3σ 之外，引入 CUSUM 检测持续性偏移。

1. 选取稳定阶段的均值作为参考基线 $\mu_0$（可用滑动均值收敛后的值）。
2. 维护正负两个累积和：

$$
S_t^+ = \max\left(0,\ S_{t-1}^+ + (x_t - \mu_0 - \delta)\right)
$$

$$
S_t^- = \max\left(0,\ S_{t-1}^- + (\mu_0 - x_t - \delta)\right)
$$

其中：

- $\delta$：参考偏移量（对小幅波动不敏感），如温度取 0.2℃，功率取 1.0W
- 初始值 $S_0^+ = S_0^- = 0$

3. **CUSUM 异常条件：**

$$
\text{若 } S_t^+ > h \lor S_t^- > h \Rightarrow \text{CUSUM 趋势异常（R2）}
$$

- $h$：决策阈值，如 5
- 触发异常后可将 $S_t^+$、$S_t^-$ 重置为 0，以便后续检测新的趋势变化

---

### 6. 组合告警策略

对每个时刻、每个指标，综合三类规则：

- **R1 静态阈值越界**：硬上限/下限保护（如温度 ≥ 85℃；功率 ≥ 300W）
- **动态 3σ 异常**：相对当前运行环境的瞬时离群点
- **CUSUM 趋势异常（R2）**：尚未触碰阈值，但出现持续升高/降低的早期异常

**综合策略示例：**

- 若 R1 触发：立刻判为严重告警（硬件风险）
- 若 动态 3σ 触发：判为一般/中级告警（瞬时异常）
- 若 CUSUM 触发：判为预警级（趋势性劣化）

可根据业务需求将多种规则合并为最终告警等级，并输出如下信息：

- 指标名（如 `Temperature`）
- 当前值 $x_t$
- 动态基线 $\mu_t$、$\sigma_t$（若适用）
- 触发规则（R1 / DynamicSigma / CUSUM）
- 趋势方向（CUSUM 正偏 / 负偏）

---

### 7. 关键参数推荐值（可工程调优）

- 滑动窗口长度：$W = 50 \sim 200$
- 最小有效样本数：$N_{\text{min}} = 20 \sim 50$
- 静态连续越界次数：$K = 3$
- 动态 3σ 灵敏度：$k_\sigma = 2.5 \sim 3.0$
- CUSUM 参考偏移量：
  - 温度：$\delta_T \approx 0.2\ \text{℃}$
  - 功率：$\delta_P \approx 1.0\ \text{W}$
- CUSUM 决策阈值：$h = 5$（可根据误报率调节）


