# 昇腾NPU分布式训练监测系统Center端需求文档

## 1. 项目概述

### 1.1 项目背景
昇腾NPU分布式训练监测系统旨在实现对大规模分布式训练过程的端到端监控与分析。Center端作为系统的核心处理节点，负责接收来自多机采集端的监控数据，进行实时异常检测、根因分析和可视化展示，为训练过程的稳定性与效率提供保障。

### 1.2 项目目标
- 实现高性能的流式数据接收与转义，支持多机并发接入
- 构建多方法融合的异常检测体系，实现实时预警
- 提供智能化的根因分析能力，快速定位问题根源
- 打造直观的可视化界面，支持实时监控与历史回溯

### 1.3 系统架构
Center端采用分层架构设计，包含以下四个核心层级：
1. **通信转义层**：负责数据接收与协议转换
2. **异常检测层**：负责实时异常检测与预警
3. **根因分析层**：负责异常根因定位与分析
4. **可视化层**：负责数据展示与交互

## 2. 功能需求

### 2.1 通信转义层需求

#### 2.1.1 数据接收功能
- **多机并发接入**：支持同时接收来自多台训练节点的监控数据流
- **流式处理**：采用流式处理模式，实时接收数据，避免数据积压
- **连接管理**：支持动态连接建立与断开，维护连接状态
- **断线重连**：支持自动重连机制，保障数据采集连续性
- **负载均衡**：支持多线程/多进程处理，合理分配接收任务

#### 2.1.2 协议处理功能
- **Protobuf解析**：解析来自采集端的Protobuf格式监控数据
- **数据校验**：对接收数据进行完整性校验，过滤异常数据包
- **版本兼容**：支持Protobuf协议版本管理，兼容不同版本采集端

#### 2.1.3 数据转义功能
- **结构化转换**：将Protobuf数据转换为系统内部结构化数据格式
- **数据标准化**：统一数据格式，包括时间戳、指标类型、数值单位等
- **数据分发**：将转义后的数据实时发送至异常检测层和可视化层
- **数据缓存**：支持短期数据缓存，应对下游处理延迟

#### 2.1.4 性能要求
- **吞吐量**：支持单机接收吞吐量≥100MB/s
- **延迟**：数据接收到转义完成延迟≤10ms（P99）
- **并发连接数**：支持≥100个并发连接
- **资源占用**：CPU占用率≤30%，内存占用≤2GB

### 2.2 异常检测层需求

#### 2.2.1 检测方法需求
系统需实现以下异常检测方法，支持通过配置选择使用：

**2.2.1.1 统计学方法**
- **3σ规则**：基于滑动窗口计算均值和标准差，检测超出3σ范围的数据点
- **静态阈值检测（R1）**：基于预设上下限阈值，检测连续越界情况
- **CUSUM趋势检测（R2）**：检测缓变指标的持续性偏移趋势
- **滑动窗口对比**：基于滑动窗口的均值±k×标准差进行异常判定

**2.2.1.2 对比分析方法**
- **Rank对比检测**：对比同一时刻不同rank的指标值，检测异常rank
- **历史迭代对比**：对比当前迭代与历史迭代的指标变化，检测性能劣化
- **DP组内对比**：检测DP组内rank的通信带宽一致性
- **跨DP组对比**：检测不同DP组间的性能差异

**2.2.1.3 经典异常检测算法**
- **孤立森林（Isolation Forest）**：适用于高维数据的异常检测
- **LOF（Local Outlier Factor）**：基于局部密度的异常检测
- **One-Class SVM**：基于支持向量机的异常检测
- **自编码器（AutoEncoder）**：基于深度学习的异常检测

#### 2.2.2 检测规则需求
根据《昇腾NPU分布式训练监测指标体系v2.0.md》，需实现以下检测规则：

**2.2.2.1 重要指标项异常（R1、R2）**
- 功率（T1）、温度（T2）、AI Core占用率（T3）、AI Cpu占用率（T4）、Ctrl Cpu占用率（T5）、内存占用率（T6）、内存带宽占用率（T7）
- 支持静态阈值越界检测和CUSUM动态趋势偏移检测

**2.2.2.2 主要NPU操作异常**
- **训练吞吐量（R3）**：基于滑动窗口的吞吐量对比检测
- **计算密集型核函数（R4）**：基于基准FLOPS的对比检测，包括aclnnFlashAttentionScore、aclnnMatmul、aclnnBatchMatMul、aclnnFFN等
- **通信带宽（R5、R6）**：组内单rank异常检验和跨DP组异常检验，包括hcclAllReduce、hcclBroadcast、hcclAllGather、hcclReduceScatter

**2.2.2.3 次要NPU操作异常（R7）**
- 次要NPU内核空窗占比检测

**2.2.2.4 步内CPU操作异常**
- **核启动延迟分布（R8）**：基于均匀性系数的检测
- **内存拷贝速率（R9）**：H2D和D2H方向的内存拷贝速率检测

**2.2.2.5 步间CPU操作异常（R10）**
- 步间CPU操作耗时占比检测

#### 2.2.3 多方法融合需求
- **并行检测**：支持同时运行多种检测方法，进行结果对比
- **结果聚合**：支持多种检测结果的融合策略（投票、加权平均等）
- **方法选择**：支持通过配置文件选择启用的检测方法
- **性能对比**：记录不同方法的检测结果，支持效果评估

#### 2.2.4 预警功能需求
- **实时预警**：检测到异常后立即生成预警事件
- **预警等级**：支持多级预警（严重、一般、预警）
- **预警去重**：避免同一异常重复预警
- **预警通知**：支持多种通知方式（日志、消息队列、API回调等）

#### 2.2.5 性能要求
- **检测延迟**：单条数据检测延迟≤50ms（P99）
- **吞吐量**：支持≥10000条/秒的检测吞吐量
- **准确率**：异常检测准确率≥90%，误报率≤5%

### 2.3 根因分析层需求

#### 2.3.1 因果图谱方法
- **图谱构建**：基于历史数据构建指标间的因果关系图谱
- **因果推理**：当异常发生时，基于因果图谱进行根因推理
- **路径分析**：分析异常传播路径，定位根因节点
- **动态更新**：支持因果图谱的动态更新与优化

#### 2.3.2 图神经网络方法
- **图结构建模**：将训练系统建模为图结构（节点为指标/组件，边为关系）
- **GNN模型**：使用图神经网络（如GCN、GraphSAGE等）进行根因分析
- **特征学习**：学习节点和边的特征表示
- **异常定位**：基于GNN输出定位异常根因节点

#### 2.3.3 其他根因分析方法
- **关联分析**：基于关联规则挖掘异常指标间的关联关系
- **时间序列分析**：分析异常发生的时间序列模式
- **相关性分析**：计算异常指标与其他指标的相关性

#### 2.3.4 分析结果需求
- **根因排序**：对识别出的根因按可能性排序
- **置信度评估**：为每个根因提供置信度评分
- **影响范围分析**：分析根因的影响范围和传播路径
- **建议措施**：提供针对性的优化建议

#### 2.3.5 性能要求
- **分析延迟**：根因分析延迟≤5秒（P99）
- **准确率**：根因定位准确率≥80%

### 2.4 可视化层需求

#### 2.4.1 实时监控展示
- **动态图表**：实时绘制监控指标的动态曲线图
- **多指标选择**：支持用户选择要显示的指标
- **时间范围选择**：支持选择不同的时间范围（实时、最近1小时、最近24小时等）
- **多节点对比**：支持同时显示多个节点的指标进行对比
- **指标分类展示**：按指标类型（全过程监控指标、分阶段监控指标）分类展示

#### 2.4.2 异常报警展示
- **报警列表**：实时显示异常报警列表，包括报警时间、指标名称、异常值、报警等级等
- **报警详情**：点击报警可查看详细信息，包括触发规则、历史趋势等
- **报警统计**：显示报警统计信息（今日报警数、各等级报警分布等）
- **报警过滤**：支持按时间、等级、指标类型等条件过滤报警

#### 2.4.3 根因分析展示
- **分析结果展示**：展示根因分析结果，包括根因列表、置信度、影响范围等
- **Loading状态**：根因分析进行中时显示Loading状态
- **因果图谱可视化**：可视化展示因果图谱和异常传播路径
- **历史分析记录**：支持查看历史根因分析记录

#### 2.4.4 交互功能需求
- **指标搜索**：支持按指标名称搜索
- **数据导出**：支持导出监控数据和报警记录
- **配置管理**：支持可视化配置检测规则参数
- **用户权限**：支持多用户权限管理

#### 2.4.5 性能要求
- **刷新频率**：实时数据刷新频率≥1Hz
- **响应时间**：页面操作响应时间≤200ms
- **并发用户**：支持≥50个并发用户访问
- **数据量支持**：支持显示≥10000个数据点的图表

## 3. 非功能需求

### 3.1 性能需求
- **系统吞吐量**：整体系统支持≥100MB/s的数据处理吞吐量
- **系统延迟**：端到端延迟（数据接收到可视化展示）≤1秒
- **资源占用**：系统总CPU占用率≤50%，内存占用≤8GB

### 3.2 可靠性需求
- **可用性**：系统可用性≥99.9%
- **容错性**：支持单点故障恢复，数据不丢失
- **数据持久化**：关键数据（报警记录、根因分析结果）需持久化存储

### 3.3 可扩展性需求
- **水平扩展**：支持通过增加节点实现水平扩展
- **插件化架构**：异常检测方法和根因分析方法支持插件化扩展
- **配置化**：系统参数支持配置文件管理，无需修改代码

### 3.4 安全性需求
- **数据加密**：支持数据传输加密（TLS/SSL）
- **访问控制**：支持用户认证和授权
- **审计日志**：记录关键操作日志，支持审计

### 3.5 可维护性需求
- **日志系统**：完善的日志系统，支持日志级别管理
- **监控告警**：系统自身运行状态监控和告警
- **文档完善**：提供完整的开发文档和运维文档

## 4. 接口需求

### 4.1 与采集端接口
- **协议**：Protobuf协议
- **传输方式**：TCP/IP或UDP（支持可靠传输）
- **数据格式**：遵循定义的Protobuf消息格式

### 4.2 内部接口
- **通信转义层→异常检测层**：结构化数据消息队列或RPC接口
- **通信转义层→可视化层**：实时数据流接口（WebSocket或消息队列）
- **异常检测层→根因分析层**：异常事件触发接口
- **异常检测层→可视化层**：异常报警推送接口
- **根因分析层→可视化层**：分析结果推送接口

### 4.3 外部接口
- **API接口**：提供RESTful API供外部系统调用
- **数据导出接口**：支持数据导出为CSV、JSON等格式

## 5. 数据需求

### 5.1 监控数据
根据《昇腾NPU分布式训练监测指标体系v2.0.md》，需处理以下监控数据：

**5.1.1 全过程监控指标**
- T1: 功率
- T2: 温度
- T3: AI Core占用率
- T4: AI Cpu占用率
- T5: Ctrl Cpu占用率
- T6: 内存占用率
- T7: 内存带宽占用率
- T8: Python的GC耗时
- T9-T14: 内存相关aclrt函数吞吐量
- T15: aclrtLaunchKernel启动时延

**5.1.2 分阶段监控指标**
- D1: DataLoader吞吐量
- F1-F4: 前向传播阶段指标（aclnnFlashAttentionScore、aclnnMatmul、aclnnBatchMatMul、aclnnFFN）
- B1-B5: 反向计算阶段指标（aclnnFlashAttentionScoreGrad、aclnnMatmul、aclnnBatchMatMul、torch.autograd.backward、torch.autograd.grad）
- G1-G7: 梯度同步&参数更新阶段指标（hccl系列通信函数、CANN流/事件同步耗时）

### 5.2 数据存储需求
- **实时数据缓存**：支持短期实时数据缓存（最近1小时）
- **历史数据存储**：支持历史数据存储（至少30天）
- **报警记录存储**：永久存储报警记录
- **根因分析结果存储**：存储根因分析结果，支持历史查询

## 6. 部署需求

### 6.1 运行环境
- **操作系统**：Linux（CentOS 7+、Ubuntu 18.04+）
- **依赖库**：Protobuf、相关C++/Python库
- **硬件要求**：CPU≥8核，内存≥16GB，磁盘≥100GB

### 6.2 部署方式
- **容器化部署**：支持Docker容器化部署
- **分布式部署**：支持分布式部署，各层可独立部署
- **配置管理**：支持配置文件外部化管理

## 7. 测试需求

### 7.1 功能测试
- 各层功能完整性测试
- 接口正确性测试
- 异常场景测试

### 7.2 性能测试
- 吞吐量测试
- 延迟测试
- 并发测试
- 压力测试

### 7.3 可靠性测试
- 故障恢复测试
- 数据一致性测试
- 长时间运行稳定性测试

